/* =========================
   ✅ Firebase Setup (Firestore)
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyA5-cHjL5iL8Arjqv2Pt2WecT8RTLw3Weg",
  authDomain: "zatam-leaderboard.firebaseapp.com",
  projectId: "zatam-leaderboard",
  storageBucket: "zatam-leaderboard.firebasestorage.app",
  messagingSenderId: "1053027312775",
  appId: "1:1053027312775:web:43325a831ab077d017c422",
  measurementId: "G-KP78X2DN6L",
};

const GAME_ID = "044-gp";
let PLAYER_NAME = "";
let db = null;

function sanitizeDocId(s) {
  // Firestore doc id cannot contain: / . # $ [ ]
  return (s || "").trim().replace(/[\/#\.\$\[\]]/g, "_");
}

function promptPlayerNameEveryLaunch() {
  let name = "";
  while (!name) {
    name = prompt("Enter your name:");
    if (name === null) name = "";
    name = (name || "").trim();
  }
  PLAYER_NAME = sanitizeDocId(name);
  return PLAYER_NAME;
}

function initFirebase() {
  try {
    if (!window.firebase) throw new Error("Firebase compat not loaded");
    if (!firebase.apps || !firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    console.log("✅ Firebase initialized");
  } catch (e) {
    console.error("❌ Firebase init failed:", e);
    db = null;
  }
}

/**
 * ✅ Adds points to YOUR schema:
 * scores_aggregate/{playerName} => { playerName, totalScore, updatedAt }
 * Also writes per-game score into scores_game/{playerName} (optional).
 */
async function addPointsToFirestore(points) {
  try {
    if (!db) throw new Error("Firestore not initialized (db is null)");
    if (!PLAYER_NAME) throw new Error("PLAYER_NAME is empty");

    const now = Date.now();

    // 1) Aggregate total leaderboard (this matches your screenshot)
    const aggRef = db.collection("scores_aggregate").doc(PLAYER_NAME);

    await aggRef.set(
      {
        playerName: PLAYER_NAME,
        totalScore: firebase.firestore.FieldValue.increment(points),
        updatedAt: now,
      },
      { merge: true }
    );

    // 2) Optional: per-game scores (useful later)
    const gameRef = db.collection("scores_game").doc(PLAYER_NAME);
    await gameRef.set(
      {
        playerName: PLAYER_NAME,
        updatedAt: now,
        games: {
          [GAME_ID]: firebase.firestore.FieldValue.increment(points),
        },
      },
      { merge: true }
    );

    console.log(`✅ +${points} saved to scores_aggregate + scores_game for ${PLAYER_NAME}`);
  } catch (e) {
    console.error("❌ Score write failed:", e);
  }
}

/* ✅ Init + prompt name every launch */
initFirebase();
promptPlayerNameEveryLaunch();

/* https://telegram.org/js/games.js */
(function () {
  function g(a) {
    try {
      return decodeURIComponent(a);
    } catch (b) {
      return a;
    }
  }
  function n(a, b, c) {
    b || (b = function () {});
    void 0 === c && (c = "");
    if (void 0 !== window.TelegramWebviewProxy) TelegramWebviewProxy.postEvent(a, c), b();
    else if (window.external && "notify" in window.external)
      window.external.notify(JSON.stringify({ eventType: a, eventData: c })), b();
    else if (k)
      try {
        var d = "https://web.telegram.org",
          d = "*";
        window.parent.postMessage(JSON.stringify({ eventType: a, eventData: c }), d);
      } catch (e) {
        b(e);
      }
    else b({ notAvailable: !0 });
  }
  function l(a, b) {
    var c = f[a];
    if (void 0 !== c && c.length)
      for (var d = 0; d < c.length; d++)
        try {
          c[d](a, b);
        } catch (e) {}
  }
  var f = {},
    m = "";
  try {
    m = location.hash.toString();
  } catch (a) {}
  var h = (function (a) {
      a = a.replace(/^#/, "");
      var b = {};
      if (!a.length) return b;
      if (0 > a.indexOf("=") && 0 > a.indexOf("?")) return (b._path = g(a)), b;
      var c = a.indexOf("?");
      if (0 <= c) {
        var d = a.substr(0, c);
        b._path = g(d);
        a = a.substr(c + 1);
      }
      a = a.split("&");
      for (var e, c = 0; c < a.length; c++)
        (e = a[c].split("=")),
          (d = g(e[0])),
          (e = null == e[1] ? null : g(e[1])),
          (b[d] = e);
      return b;
    })(m),
    k = !1;
  try {
    k = null != window.parent && window != window.parent;
  } catch (a) {}
  window.TelegramGameProxy_receiveEvent = l;
  window.TelegramGameProxy = {
    initParams: h,
    receiveEvent: l,
    onEvent: function (a, b) {
      void 0 === f[a] && (f[a] = []);
      -1 === f[a].indexOf(b) && f[a].push(b);
    },
    shareScore: function () {
      n("share_score", function (a) {
        if (a && (a = h.tgShareScoreUrl || h.shareScoreUrl)) {
          var b = !1;
          try {
            b = window.open(a, "_blank");
          } catch (c) {
            b = !1;
          }
          b || (location.href = a);
        }
      });
    },
  };
})();

/* Math Battle */
(function (R, r) {
  function g(a) {
    return "string" == typeof a ? r.getElementById(a) : a;
  }
  function S(a) {
    return (a || "").replace(/^[\s\uFEFF]+|[\s\uFEFF]+$/g, "");
  }
  function y(a, b) {
    return (a = g(a)) && new RegExp("(\\s|^)" + b + "(\\s|$)").test(a.className);
  }
  function t(a, b) {
    (a = g(a)) && !y(a, b) && (a.className = S(a.className + " " + b));
  }
  function w(a, b) {
    (a = g(a)) && y(a, b) && (a.className = S(a.className.replace(new RegExp("(\\s+|^)" + b + "(\\s+|$)"), " ")));
  }
  function z(a, b, c) {
    ("undefined" == typeof c ? y(a, b) : !c) ? w(a, b) : t(a, b);
  }
  function p(a, b, c) {
    if (((a = g(a)), (c = c || rf), a && 3 != a.nodeType && 8 != a.nodeType)) {
      a.setInterval && a != R && (a = R);
      b = b.split(" ");
      for (var d = 0, f = b.length; f > d; d++) {
        var e = b[d];
        a.addEventListener ? a.addEventListener(e, c, !1) : a.attachEvent && a.attachEvent("on" + e, c);
      }
    }
  }
  function l(a, b) {
    return Math.floor(Math.random() * (b - a + 1) + a);
  }
  function T() {
    var a = l(1, 4e3) % 4;
    var b = 500 >= l(1, 1e3);
    hard = 30 < u;
    a = ["+", "\u2013", "\u00d7", "/"][a];
    switch (a) {
      case "+":
      case "\u2013":
        if ("+" == a) {
          var c = l(hard ? 10 : 0, hard ? 200 : 100);
          var d = l(hard ? 10 : 0, hard ? 200 : 100);
          var f = c + d;
        } else (f = l(hard ? 10 : 0, hard ? 200 : 100)), (d = l(hard ? 10 : 0, hard ? 200 : 100)), (c = f + d);
        if (!b) {
          var e = Math.min(c, d);
          e = Math.min(e, f);
          (e = l(-e, e)) || e++;
          f += e;
        }
        break;
      case "\u00d7":
      case "/":
        "\u00d7" == a
          ? ((c = l(hard ? 3 : 1, hard ? 20 : 10)), (d = l(hard ? 3 : 1, hard ? 20 : 10)), (f = c * d))
          : ((f = l(hard ? 3 : 1, hard ? 20 : 10)), (d = l(hard ? 3 : 1, hard ? 20 : 10)), (c = f * d)),
          b || ((e = Math.min(c, d)), (e = Math.min(e, f)), (e = l(-e, e)) || e++, (f += e));
    }
    return { x: c, op: a, y: d, res: f, correct: b };
  }
  function U() {
    clearTimeout(F);
    V(!0);
    x && (F = setTimeout(U, 30));
  }
  function V(a, b) {
    if (0 < v - +new Date()) return G(b);
    clearTimeout(F);
    x = !1;
    a
      ? W()
      : G(b, function () {
          W();
        });
  }
  function H() {
    var a = +u || "0";
    ha.innerHTML = Sanscript.t(String(a), "iast", "devanagari");
    ia.innerHTML = Sanscript.t(String(a), "iast", "devanagari");
  }
  function I() {
    m &&
      ((ja.innerHTML = Sanscript.t(String(m.x), "iast", "devanagari")),
      (ka.innerHTML = Sanscript.t(String(m.op), "iast", "devanagari")),
      (la.innerHTML = Sanscript.t(String(m.y), "iast", "devanagari")),
      (ma.innerHTML = Sanscript.t(String(m.res), "iast", "devanagari")));
  }
  function na() {
    clearTimeout(X);
    t(Y, "tossing");
    X = setTimeout(function () {
      w(Y, "tossing");
    }, 700);
  }
  function G(a, b) {
    var c = (v - +new Date()) / 1e4;
    0 > c && (c = 0);
    1 < c && (c = 1);
    a &&
      (clearTimeout(Z),
      t(J, "animated"),
      (Z = setTimeout(function () {
        w(J, "animated");
      }, 500)));
    J.style.right = 100 - 100 * c + "%";
    b && setTimeout(b, 600);
  }
  function L() {
    z(M, "in_greet", !A);
    z(M, "in_game", !n);
    z(M, "in_result", n);
  }
  function N() {
    x = A = !0;
    n = !1;
    m = T();
    v = +new Date() + 1e4;
    u = 0;
    B = !1;
    U();
    H();
    I();
    G();
    L();
    z(O, "shown", B);
  }
  function W() {
    if (!n) {
      n = !0;
      L();
    }
  }

  // ✅ THIS is the key fix:
  // Correct button passes a=true, wrong button passes a=false
  // A "right answer" means: a === m.correct
  function D(a) {
    if (!x) return;

    const isCorrect = (a === m.correct);

    if (isCorrect) {
      v += 1500;
      1e4 < v - +new Date() && (v = +new Date() + 1e4);
      u++;
      H();

      // ✅ +10 points to Firestore
      addPointsToFirestore(10);
    } else {
      v -= 4e3;
      na();
    }

    V(!1, isCorrect);
    m = T();
    I();
  }

  function P(a) {
    t(a, "hover");
    setTimeout(function () {
      w(a, "hover");
    }, 100);
  }

  var v,
    F,
    A = !1,
    x = !1,
    n = !0,
    m,
    u = 0,
    B;

  var ha = g("score_value"),
    ia = g("result_score_value"),
    O = g("score_share"),
    Y = g("task"),
    ja = g("task_x"),
    ka = g("task_op"),
    la = g("task_y"),
    ma = g("task_res"),
    J = g("timeline_progress"),
    M = g("page_wrap");

  var E = g("game_title");
  if (E) E.innerHTML = "गणितपरीक्षा — " + PLAYER_NAME;

  var Q = g("button_correct"),
    fa = g("button_wrong"),
    X,
    Z;

  p(E, "click", function () {
    A || N();
  });
  p(Q, "click", function () {
    !A || n ? N() : D(true);
  });
  p(fa, "click", function () {
    x && D(false);
  });
  p(O, "click", function () {
    B && TelegramGameProxy && TelegramGameProxy.shareScore();
  });

  p(r, "keydown", function (a) {
    a.preventDefault();
    a = a.which || a.keyCode;
    x ? (37 == a && (P(Q), D(true)), 39 == a && (P(fa), D(false))) : (A && !n) || 32 != a || (P(Q), N());
  });

  H();
  I();
  L();
  // enable gameplay
  x = true;

  var k = {
    obj: null,
    start: function (a) {
      a.touches && 1 == a.touches.length && (k.end(a), (k.obj = this || null), k.obj && t(k.obj, "hover"));
    },
    cancel: function (a) {
      k.obj && k.end(a);
    },
    end: function () {
      k.obj && (w(k.obj, "hover"), (k.obj = null), (k.highlight = !1));
    },
    check: function (a) {
      if (!a) return !1;
      do if (y(a, "button") || y(a, "score_share")) return a;
      while ((a = a.parentNode));
      return !1;
    },
  };
  p(r, "touchmove touchcancel", k.cancel);
  p(r, "touchend", k.end);
  p(r, "touchstart", function (a) {
    var b = k.check(a.target);
    b && k.start.call(b, a);
  });
  "ontouchstart" in r || t(r.body, "_hover");
})(window, document);
